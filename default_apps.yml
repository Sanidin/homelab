---

- hosts: all
  become: true
  tasks:

  - name: Install OpenSCAP Scanner
    package:
      name: openscap-scanner
      state: latest
      enablerepo: epel

  - name: Ensure SSH daemon is running.
    service:
      name: "sshd"
      state: "started"

  - name: Update SSH configuration to be more secure.
    lineinfile:
      dest: "{{ security_ssh_config_path }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      state: present
      validate: 'sshd -T -f %s'
      mode: 0644
    with_items:
      - regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
      - regexp: "^UseDNS"
        line: "UseDNS no"
      - regexp: "^PermitEmptyPasswords"
        line: "PermitEmptyPasswords no"
      - regexp: "^ChallengeResponseAuthentication"
        line: "ChallengeResponseAuthentication no"
      - regexp: "^GSSAPIAuthentication"
        line: "GSSAPIAuthentication no"
      - regexp: "^X11Forwarding"
        line: "X11Forwarding no"
    notify: restart ssh

  - name: Install fail2ban
    package:
      name: fail2ban
      state: present
      enablerepo: epel

  - name: Copy fail2ban custom configuration file into place.
    template:
      src: "jail.local.j2"
      dest: /etc/fail2ban/jail.local
      owner: root
      group: root
      mode: 0644

  - name: Ensure fail2ban is running and enabled on boot.
    service:
      name: fail2ban
      state: started
      enabled: true