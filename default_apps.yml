---

- hosts: all
  become: true
  tasks:

  - name: Install OpenSCAP Scanner
    package:
      name: openscap-scanner
      state: latest

  - name: Ensure SSH daemon is running.
    service:
      name: "sshd"
      state: "started"

  - name: Update SSH configuration to be more secure.
    lineinfile:
      dest: "{{ security_ssh_config_path }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      state: present
      validate: 'sshd -T -f %s'
      mode: 0644
    with_items:
      - regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
      - regexp: "^UseDNS"
        line: "UseDNS no"
      - regexp: "^PermitEmptyPasswords"
        line: "PermitEmptyPasswords no"
      - regexp: "^ChallengeResponseAuthentication"
        line: "ChallengeResponseAuthentication no"
      - regexp: "^GSSAPIAuthentication"
        line: "GSSAPIAuthentication no"
      - regexp: "^X11Forwarding"
        line: "X11Forwarding no"
    notify: restart ssh
